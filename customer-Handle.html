<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div id="root"></div>
    <script src="./js/react.development.js"></script>
    <script src="./js/react-dom.development.js"></script>
    <script src="./js/babel.js"></script>
    <script src="./customers.js"></script>
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>

    <script type="text/babel">
      const rootHandle = document.getElementById("root");
      const { useState } = React;

      function PieChart(props) {
        google.charts.load("current", { packages: ["corechart"] });
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
          const data = google.visualization.arrayToDataTable([
            //passing props value in  chart
            ["No Of Orders", "No of Customers", { role: "style" }],
            ["1", props.data["1"], "color: #605398"],
            ["2", props.data["2"], "color: #605398"],
            ["3", props.data["3"], "color:#605398"],
            ["4", props.data["4"], "color:#605398"],
            ["5+", props.data["5+"], "color:#605398"],
          ]);

          const view = new google.visualization.DataView(data);

          const options = {
            title: "Customer Distribution ",
            width: 500,
            height: 300,
            fontSize: 25,
            backgroundColor: "limegreen",
            bar: { groupWidth: "50%" },
            legend: { position: "none" },
          };
          const chart = new google.visualization.ColumnChart(
            document.getElementById("columnchart_values")
          );
          chart.draw(view, options);
        }

        return (
          <div
            id="columnchart_values"
            style={{
              width: "600px",
              height: " 300px",
            }}
          ></div>
        );
      }

      function CustomerDistribution(props) {
        const { data } = props;
        const obj = {},
          distribution = {};

        for (const user of data) {
          if (obj.hasOwnProperty(user.Phone)) {
            obj[user.Phone] += 1;
          } else {
            obj[user.Phone] = 1;
          }
        }
        // console.log(obj);
        // This for loop is for grouping the same value
        for (const key in obj) {
          if (!distribution.hasOwnProperty(obj[key]) && obj[key] < 5) {
            distribution[obj[key]] = 1;
          } else if (!distribution.hasOwnProperty(obj[key]) && obj[key] >= 5) {
            let item = 1;
            distribution["5+"] >= 1
              ? (distribution["5+"] += item)
              : (distribution["5+"] = 1);
          } else {
            distribution[obj[key]] += 1;
          }
        }
        // console.log(distribution);
        return (
          <div id="child">
            <table border="4" id="small_table">
              <thead>
                <tr>
                  <th>No. of orders</th>
                  <th>Count of Customers</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>1</td>
                  <td>{distribution[1]}</td>
                </tr>
                <tr>
                  <td>2</td>
                  <td>{distribution[2]}</td>
                </tr>
                <tr>
                  <td>3</td>
                  <td>{distribution[3]}</td>
                </tr>
                <tr>
                  <td>4</td>
                  <td>{distribution[4]}</td>
                </tr>
                <tr>
                  <td>5+</td>
                  <td>{distribution["5+"]}</td>
                </tr>
              </tbody>
            </table>
            <PieChart data={distribution} />
          </div>
        );
      }

      function SiteInformation(props) {
        const { data } = props;

        const calcAmount = () => {
          let sum = 0;
          data.forEach((ele) => {
            sum += ele.Amount;
          });
          return sum;
        };

        // Total Site Customers have
        const CustomerSite = () => {
          // Method1 by using set()
          // const uniqueArray = data.map((user) => user.Name);
          // const newSet = new Set(uniqueArray);
          // console.log(newSet.size);
          // return newSet.size;

          // Method2 by using filter method
          const obj = {};
          let newArray = [...data];
          newArray = newArray.filter((user) => {
            let alreadyExists = obj.hasOwnProperty(user.Phone);
            return alreadyExists ? false : (obj[user.Phone] = true);
          });
          // console.log(newArray);
          return newArray.length;
        };

        return (
          <div id="order">
            <h2> Site Received total - {data.length} orders </h2>
            <h2>Total Amount of Orders - {calcAmount()}</h2>
            <h2>Total Number of Customers - {CustomerSite()}</h2>
          </div>
        );
      }

      function SearchUser(props) {
        const { displayTable } = props;

        return (
          <button onClick={displayTable} id="btn">
            Search
          </button>
        );
      }

      function CustomerHandle(props) {
        const data = customers;
        const newObj = {};

        const uniqueData = data.filter((user) => {
          let alreadyExists = newObj.hasOwnProperty(user.Phone);
          return alreadyExists ? false : (newObj[user.Phone] = true);
        });
        const [info, setInfo] = useState(uniqueData);

        // Customer Order Detail.
        const orderDetail = (name) => {
          const userOrder = data.filter((ele) => {
            return ele.Name === name;
          });
          // console.log(userOrder);
          const orderAmount = userOrder.map((ele) => {
            return ele.Amount;
          });
          // console.log(orderAmount);
          const TotalAmount = orderAmount.reduce((a, b) => {
            return a + b;
          });
          alert(
            `Total Order - ${userOrder.length}
            \n Amount of each order - ${orderAmount.join()}
            \n Total Order Amount - ${TotalAmount}`
          );
        };
        const displayTable = () => {
          const newData = [...data];
          const input = prompt("Enter Phone number or Name");
          const result = newData.find((user) => {
            if (user.Phone === Number(input) || user.Name === input) {
              return true;
            }
          });
          if (result !== undefined) {
            setInfo([result]);
          } else {
            setInfo(newData);
            alert("Sorry Enter Valid input");
          }
        };
        return (
          <div id="main">
            <SearchUser displayTable={displayTable} />
            <SiteInformation data={data} />
            <CustomerDistribution data={data} />
            <table border="4" id="main_table">
              <thead>
                <tr>
                  <th>Index</th>
                  <th>Phone</th>
                  <th>Name</th>
                  <th>Show OrderDetail</th>
                </tr>
              </thead>
              <tbody>
                {info.map((user, i) => {
                  return (
                    <tr key={i}>
                      <td>{i + 1}</td>
                      <td>{user.Phone}</td>
                      <td>{user.Name}</td>
                      <td
                        onClick={() => {
                          orderDetail(user.Name);
                        }}
                      >
                        Order Detail
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        );
      }

      function App() {
        return <CustomerHandle />;
      }
      ReactDOM.render(<App />, rootHandle);
    </script>
  </body>
</html>
