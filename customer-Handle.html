<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div id="root"></div>
    <script src="./js/react.development.js"></script>
    <script src="./js/react-dom.development.js"></script>
    <script src="./js/babel.js"></script>
    <script src="./js/lodash.js"></script>
    <script src="./customers.js"></script>
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>

    <script type="text/babel">
      const rootHandle = document.getElementById("root");
      const { useState } = React;

      function PieChart(props) {
        google.charts.load("current", { packages: ["corechart"] });
        google.charts.setOnLoadCallback(drawChart);

        const { data } = props;
        const chartData = [["No of Orders", "Customer Count"]];
        for (const key in data) {
          chartData.push([key, data[key]]);
        }

        function drawChart() {
          const data = google.visualization.arrayToDataTable(chartData);
          const options = {
            title: "Customer Distribution ",
            width: 500,
            height: 300,
            fontSize: 25,
            backgroundColor: "limegreen",
            bar: { groupWidth: "50%" },
            legend: { position: "none" },
          };
          const chart = new google.visualization.ColumnChart(
            document.getElementById("columnchart_values")
          );
          chart.draw(data, options);
        }

        return (
          <div
            id="columnchart_values"
            style={{
              width: "600px",
              height: " 300px",
            }}
          ></div>
        );
      }

      function CustomerDistribution(props) {
        const { data } = props;
        // console.log(data.length);
        const distribution = { 1: 0, 2: 0, 3: 0, 4: 0, "5+": 0 };

        // This for loop is for grouping the same value
        const uniqData = _.uniqBy(data, "Phone");
        uniqData.forEach((customer) => {
          const customerOrders = data.filter((cust) => {
            return cust.Phone === customer.Phone;
          });
          if (customerOrders.length >= 5) {
            distribution["5+"] += 1;
          } else {
            distribution[customerOrders.length] += 1;
          }
        });
        // console.log(distribution);
        return (
          <div id="child">
            <table border="4" id="small_table">
              <thead>
                <tr>
                  <th>No. of orders</th>
                  <th>Count of Customers</th>
                </tr>
              </thead>
              <tbody>
                {Object.keys(distribution).map((ele, i) => {
                  return (
                    <tr key={i}>
                      <td>{ele}</td>
                      <td>{distribution[ele]}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
            <PieChart data={distribution} />
          </div>
        );
      }

      function SiteInformation(props) {
        const { data } = props;

        const calcAmount = () => {
          let sum = 0;
          data.forEach((ele) => {
            sum += ele.Amount;
          });
          return sum;
        };

        // Total Site Customers have
        const CustomerSite = () => {
          // By using _.uniqBy method from lodash library

          const newArray = _.uniqBy(data, "Phone");
          return newArray.length;
        };

        return (
          <div id="order">
            <h2> Site Received total - {data.length} orders </h2>
            <h2>Total Amount of Orders - {calcAmount()}</h2>
            <h2>Total Number of Customers - {CustomerSite()}</h2>
          </div>
        );
      }

      function SearchUser(props) {
        const { displayTable } = props;

        return (
          <button onClick={displayTable} id="btn">
            Search
          </button>
        );
      }

      function CustomerHandle(props) {
        const data = customers;
        const uniqueData = _.uniqBy(data, "Phone"); //We used here lodash library to find unique data by using _.uniqBy Method.
        // console.log(uniqueData);
        const [info, setInfo] = useState(uniqueData);

        // Customer Order Detail.
        const orderDetail = (phone, name) => {
          const userOrder = data.filter((ele) => {
            return ele.Phone === phone;
          });
          // console.log(userOrder);
          const orderAmount = userOrder.map((ele) => {
            return ele.Amount;
          });
          // console.log(orderAmount);
          const TotalAmount = orderAmount.reduce((a, b) => {
            return a + b;
          });
          alert(
            `Name - ${name}
            \nTotal Order - ${userOrder.length}
            \n Amount of each order - ${orderAmount.join()}
            \n Total Order Amount - ${TotalAmount}`
          );
        };
        const displayTable = () => {
          const newData = [...data];
          const input = prompt("Enter Phone number or Name");
          const result = newData.find((user) => {
            if (user.Phone === Number(input) || user.Name === input) {
              return true;
            }
          });
          if (result !== undefined) {
            setInfo([result]);
          } else {
            setInfo(newData);
            alert("Sorry Enter Valid input");
          }
        };
        return (
          <div id="main">
            <SearchUser displayTable={displayTable} />
            <SiteInformation data={data} />
            <CustomerDistribution data={data} />
            <table border="4" id="main_table">
              <thead>
                <tr>
                  <th>Index</th>
                  <th>Phone</th>
                  <th>Name</th>
                  <th>Show Detail</th>
                </tr>
              </thead>
              <tbody>
                {info.map((user, i) => {
                  return (
                    <tr key={i}>
                      <td>{i + 1}</td>
                      <td>{user.Phone}</td>
                      <td>{user.Name}</td>
                      <td>
                        <button
                          onClick={() => {
                            orderDetail(user.Phone, user.Name);
                          }}
                        >
                          Order Detail
                        </button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        );
      }

      function App() {
        return (
          <div>
            <h1>Customer Dashboard</h1>
            <CustomerHandle />;
          </div>
        );
      }
      ReactDOM.render(<App />, rootHandle);
    </script>
  </body>
</html>
